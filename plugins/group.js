const { cmd, commands } = require('../command');
const { readEnv } = require('../lib/database');
const config = require('../config');
const {cmd , commands} = require('../command');

cmd({
    pattern: "tagall",
    desc: "Tags every person in the group.",
    category: "group",
    filename: __filename,
}, async (conn, mek, m, { from, quoted, body, isCmd, command, args, q, isGroup, sender, senderNumber, botNumber, pushname, groupMetadata, participants, groupAdmins, isBotAdmins, isAdmins, reply }) => {
    try {
        if (!isGroup) return reply("This command can only be used in a group.");
        
        // Fetch group metadata to get participants
        groupMetadata = await conn.groupMetadata(from);
        participants = groupMetadata.participants;

        let textt = `
â—â•¤â•¤âœªã€˜ *Tag All* ã€™âœªâ•¤â•¤â—‘

â² *Message:* ${args.join(' ') || "blank"}\n\n
â² *Author:* ${pushname} ğŸ’€
        `;
        
        // Loop through participants and tag each member
        for (let mem of participants) {
            textt += `ğŸ‘¤ @${mem.id.split('@')[0]}\n`;
        }

        // Send the tagged message
        await conn.sendMessage(from, {
            text: textt,
            mentions: participants.map(a => a.id),
        }, { quoted: mek });

    } catch (e) {
        console.log(e);
        reply("An error occurred while trying to tag all members.");
    }
});

//join command
cmd({
    pattern: "join",
    desc: "joins group by link",
    category: "owner",
    use: '<group link>',
}, async (conn, mek, m, { from, text, isCreator, reply }) => {
    try {
        if (!isCreator) return reply(tlang().owner);
        if (!text) return reply(`Please provide a link ${tlang().greet}`);
        
        const link = text.split(" ")[0];
        
        if (!link || !link.includes("whatsapp.com")) {
            return reply("Invalid link. Please send a valid WhatsApp group link!");
        }

        const groupCode = link.split("https://chat.whatsapp.com/")[1];
        
        if (!groupCode) {
            return reply("Invalid WhatsApp group link. Make sure it's the correct format.");
        }

        await conn.groupAcceptInvite(groupCode);
        reply("ğŸ˜ Joined the group successfully.");
    } catch (err) {
        console.log(err);
        reply("Error in joining the group. Please check the link.");
    }
});

//invite link
cmd({
    pattern: "invite",
    alias: ["glink"],
    desc: "Get group invite link.",
    category: "group",
    filename: __filename,
}, async (conn, mek, m, { from, quoted, body, args, q, isGroup, sender, reply }) => {
    try {
        // Ensure this is being used in a group
        if (!isGroup) return reply("This command can only be used in a group.");

        // Get the sender's number
        const senderNumber = sender.split('@')[0];
        const botNumber = conn.user.id.split(':')[0];
        
        // Check if the bot is an admin
        const groupMetadata = isGroup ? await conn.groupMetadata(from) : '';
        const groupAdmins = groupMetadata ? groupMetadata.participants.filter(member => member.admin) : [];
        const isBotAdmins = isGroup ? groupAdmins.some(admin => admin.id === botNumber + '@s.whatsapp.net') : false;
        
        if (!isBotAdmins) return reply("I need to be an admin to generate the group link.");

        // Check if the sender is an admin
        const isAdmins = isGroup ? groupAdmins.some(admin => admin.id === sender) : false;
        if (!isAdmins) return reply("You must be an admin to generate the group link.");

        // Get the invite code and generate the link
        const inviteCode = await conn.groupInviteCode(from);
        if (!inviteCode) return reply("Failed to retrieve the invite code.");

        const inviteLink = `https://chat.whatsapp.com/${inviteCode}`;

        // Reply with the invite link
        return reply(`*Here is your group invite link:*\n${inviteLink}`);
        
    } catch (error) {
        console.error("Error in invite command:", error);
        reply(`An error occurred: ${error.message || "Unknown error"}`);
    }
});

//mute
cmd({
    pattern: "mute",	
    alias: ["lock"],
    react: "ğŸ”’",
    desc: "mute group.",
    category: "group",
    filename: __filename,
},
async(conn, mek, m,{from, l, quoted, body, isCmd, command, args, q, isGroup, sender, senderNumber, botNumber2, botNumber, pushname, isMe, isOwner, groupMetadata, groupName, participants,  isItzcp, groupAdmins, isBotAdmins, isAdmins, reply}) => {
try{
    
if (!isOwner || !isAdmins) return;


if (!m.isGroup) return reply(mg.onlygroup);
if (!isBotAdmins) return reply(mg.needbotadmins);     
            await conn.groupSettingUpdate(m.chat, "announcement")
           const mass = await conn.sendMessage(m.chat, { text: '*GROUP CHAT MUTED BY SILENT-SOBX-MD* ğŸ”’' }, { quoted: mek });
            return await conn.sendMessage(m.chat, { react: { text: 'ğŸ”’', key: mass.key } });
} catch(e) {
console.log(e);
reply('*PLEASE GIVE ME A ADDMIN ROLEâ—ğŸ‘»*')    
} 
})

cmd({
    pattern: "unmute",	
    alias: ["unlock"],
    react: "ğŸ”“",
    desc: "unmute group.",
    category: "group",
    filename: __filename,
},
async(conn, mek, m,{from, l, quoted, body, isCmd, command, args, q, isGroup, sender, senderNumber, botNumber2, botNumber, pushname, isMe, isOwner, groupMetadata, groupName, participants,  isItzcp, groupAdmins, isBotAdmins, isAdmins, reply}) => {
try{
    
if (!isOwner || !isAdmins) return;


if (!m.isGroup) return reply(mg.onlygroup);
if (!isBotAdmins) return reply(mg.needbotadmins);     
            await conn.groupSettingUpdate(m.chat, "not_announcement")
           const mass = await conn.sendMessage(m.chat, { text: '*GROUP CHAT UNMUTED BY SILENT-SOBX-MD* ğŸ”’' }, { quoted: mek });
            return await conn.sendMessage(m.chat, { react: { text: 'ğŸ”’', key: mass.key } });
} catch(e) {
console.log(e);
reply('*PLEASE GIVE ME A ADDMIN ROLEâ—ğŸ‘»*')    
} 
})
